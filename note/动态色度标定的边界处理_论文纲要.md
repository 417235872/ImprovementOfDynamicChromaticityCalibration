# 动态色度标定的边界处理提纲

## 1 数据预处理

​		从仪器中得到的原始数据一般并不直接进行色度标定处理，而是先通过滤波平滑和方位插值操作处理之后再进行色度标定。通过滤波操作对数据进行平滑操作，可以减少噪声的干扰，常用滤波方法有低通滤波、均值滤波、高斯滤波等。方位插值方法可以对数据在角度方位增加数据量，是增加角度方向图像分辨率的常用手段。这里采高斯滤波滤波方法和三次样条插值方法对原始数据进行预处理。

![滤波](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\滤波.png)

## 2 经典色度标定方法

### 2.1 静态色度标定

​		在测井成像时，需要将测井数据转换成色标值在计算机上显示，由此色度标定测井成像中非常关键的环节。静态色度标定是根据在整个井段的数据分布得到一个映射函数，函数可以表示如下：
$$
f(V_i) = V_i*S+V_{offset} \tag{1}
$$
​		其中S与V_{offset}是刻度系数和偏移量，这些参数可以根据井段数据的最大值V\_{max}和最小值V\_{min}、色标最小值C\_{min}和色标最大值C\_{max} 求得：
$$
S=(C_{max}-C_{min})/(V_{max}-V_{min}) \tag{2} 
$$

$$
V_{offset}=C_{min}-V_{min}*S \tag{3}
$$

### 2.2 动态色度标定

​	静态色度标定相当于基于全部井段数据进行的一次直方图均衡化处理，然而这种处理方式在数据分布不均匀时，即使进行了直方图均衡化仍然会有大量数据堆积在一小段区域，从而使图像的局部细节特征不明显。针对这个问题，赖富强提出了动态色度标定法。

​	动态色度标定法首先需要选取一个滑动窗长，在窗长范围内进行静态色度标定，然后在整个处理井段上按照一定步长移动窗口（步长一般取窗长的4/5），重复做静态色度标定直到完成整个井段的色度标定。

## 3 动态色度标定的改进方案

​	在两个相邻窗的边界，两个窗的V_max和V_min相差较大时，由式(2)与式(3)计算得到的S和V_offset也存在较大差异，因此测井数据在两个窗边界处的色度标定结果会产生突变，由此形成阶跃断层。对于这种情况，我们需要对动态色度标定进行一些改进来消除其阶跃断层。这里我们提出了几种与自适窗长法不同的方法来减弱其产生的断层现象：

![直方图均衡_all_autoRange](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\直方图均衡_all_autoRange.png)

### 3.1 平均值法

#### 3.1.1 基本算法

​		平均值法与经典的动态色度标定法类似，首先选取一个滑动窗长，不断移动窗口并在窗口中进行静态色度标定。与之不同之处在于，平均值法一般选取窗长1/5为滑动步长，滑动处理完整个井段数据后，每段数据都经历了五次静态色度标定（开始部分和结束部分少于5次），最终结果由这段数据所有静态色度标定的加权平均值决定。

​		下表是对于每次平均值法色度标定的示意，每1/5窗长的数据称为一个数据块，每次色度标定将会选取连续的5个数据块进行静态色度标定，每一的静态色度标定用大写字母表示，数字下标表示结果是当前静态色度标定的第几个数据块的结果。

<table>
   <tr>
      <td>测井数据块</td>
      <td>第1次标定</td>
      <td>第2次标定</td>
      <td>第3次标定</td>
      <td>第4次标定</td>
      <td>第5次标定</td>
      <td>第6次标定</td>
      <td>第7次标定</td>
   </tr>
   <tr>
      <td>1</td>
      <td>A1</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>2</td>
      <td>A2</td>
      <td>B1</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>3</td>
      <td>A3</td>
      <td>B2</td>
      <td>C1</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>4</td>
      <td>A4</td>
      <td>B3</td>
      <td>C2</td>
      <td>D1</td>
      <td></td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>5</td>
      <td>A5</td>
      <td>B4</td>
      <td>C3</td>
      <td>D2</td>
      <td>E1</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>6</td>
      <td></td>
      <td>B5</td>
      <td>C4</td>
      <td>D3</td>
      <td>E2</td>
      <td>F1</td>
      <td></td>
   </tr>
   <tr>
      <td>7</td>
      <td></td>
      <td></td>
      <td>C5</td>
      <td>D4</td>
      <td>E3</td>
      <td>F2</td>
      <td>G1</td>
   </tr>
   <tr>
      <td>8</td>
      <td></td>
      <td></td>
      <td></td>
      <td>D5</td>
      <td>E4</td>
      <td>F3</td>
      <td>G2</td>
   </tr>
   <tr>
      <td>9</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>E5</td>
      <td>F4</td>
      <td>G3</td>
   </tr>
   <tr>
      <td>10</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>F5</td>
      <td>G4</td>
   </tr>
   <tr>
      <td>11</td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>G5</td>
   </tr>
   <tr>
      <td></td>
   </tr>
</table>



对于第五个测井数据块的标定结果由以下公式计算：
$$
\boldsymbol V_{result}=\frac{\begin{bmatrix} w_1 & w_2 & w_3 & w_4 & w_5 \end{bmatrix} \cdot \begin{bmatrix} \boldsymbol A_5 & \boldsymbol B_4 & \boldsymbol C_3 & \boldsymbol D_2 & \boldsymbol E_1 \end{bmatrix}}{\begin{bmatrix} w_1 & w_2 & w_3 & w_4 & w_5 \end{bmatrix} \cdot \begin{bmatrix} 1 & 1 & 1 & 1 & 1 \end{bmatrix}} \tag{4}
$$
*w*为权值，一般使用用单位向量或者高斯算子作为权值。

#### 3.1.2 减弱阶跃断层的原理

​		通过平均值法，对于S和V_offset随窗口移动而产生的一次大的突变被划分成多端阶梯状变化，由此令S和V_offset随窗口移动的变换值变小，同时对当前数据块进行静态数据标定所关联的数据并未变少，由此有效的减弱阶跃断层的程度。

![平均值法参数变换](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\平均值法参数变换.png)

### 3.2 渐变过渡法

#### 3.2.1 基本算法

​		渐变过渡法并不改变色度标定的窗长和滑动步长，由于每次滑动4/5窗长后，前一次静态标定和后一次静态标定的数据存在1/5窗口长度的重叠部分，通过对与重叠的1/5窗长进行处理可以有效消除阶跃断层。

​		重叠的部分经过了两次静态色度标定，得到在前一个窗口下的静态色度标定和后一个窗口下的静态色度标定的两组色标值**V_first**、**V_second**，对于这两段色标值分别乘上一个权值**W_first**、**W_second**，然后相加得到重叠部分最终的色标值。权值**W_first**、**W_second**需要满足以下两个条件：

1. **W_first**随下标由1逐渐降低到0，**W_second**随下标由0逐渐上升到1
2. **W_first**、**W_second**相同下标值相加等于1

对于重叠部分通过公式**(5)**计算得到最终的色标值**V_result**：
$$
\boldsymbol V_{result} = \vec w_{first}^\intercal \boldsymbol{V_{first}} + \vec w_{second}^\intercal \boldsymbol{V_{second}} \tag{5}
$$

​		实际使用中一般使用线性渐变权值便可以有效消除边界的阶跃断层。

![渐变权值](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\渐变权值.svg)

#### 3.2.2 减弱阶跃断层的原理

​		相较于经典动态色度标定方法在某一点上产生ΔS和ΔV_offset的阶跃变化而产生阶跃断层，渐变过渡法利用重叠区域，让前一个窗口的刻度系数和偏移量线性的变化到后一个窗口的值，从而使刻度系数和偏移量一阶连续，由此消除了阶跃断层的现象。

![渐变过渡法参数变换](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\渐变过渡法参数变换.png)

### 3.3 自适应动态色度标定

#### 3.3.1 基本算法

​		参考计算视觉的自适应直方图均衡方法，对动态色度标定进行改进得到自适应动态色度标定。

​		自适应动态色度标定同样需要选定一个窗长，对于每个深度点D，截取前后相当于1/2窗长的数据（总长度为一个窗长），通过这段数据中的最大值与最小值计算得到一个静态色度标定映射函数，这个映射函数只会作用于选取的深度点D而不是整个窗口内的数据。由于井段开始部分和结束部分的深度点前方或后方的数据不足1/2窗长，因此这两个部分的使用经典动态色度标定的结果。

#### 3.3.2 减弱阶跃断层的原理

​		利用自适应动态色度标定法，每个深度点的刻度系数和偏移量都依赖于以自身为中心的窗长范围内的最大最小值。由于测井数据在经过平滑后是一阶连续的，因此对于作用于每个深度映射函数的参数S与V_offset会随着深度点一阶连续，不会产生类似动态色度标定时在的突变，这样也可以有效的消除边界的阶跃断层。

![自适应动态色度标定法参数变换](C:\Users\jimbook\Desktop\project\wellPlotAnalyze\image\自适应动态色度标定法参数变换.png)

## 4 结论

​		通过几种对于动态色度标定的改进方法，可以有效的消减和消除由于相邻窗上色度标定映射函数的参数差异过大导致的阶跃断层，测井解释人员可以更好的从动态色度标定的方位成像图中判断地层、裂隙等信息。

